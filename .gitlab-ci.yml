# use ubuntu library image until our works
image: registry.gitlab.com/untrustedhost/docker-in-docker
services:
  - docker:dind
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
#  RELEASE_IMAGE:
  GITLAB_RELEASE_IMAGE: registry.gitlab.com/untrustedhost/baseimages/ubuntu
  TEXT_FACT_FILE: baseimage.txt
  TIMESTAMP_KEY: base_image_timestamp
  CODEREV_KEY: base_image_coderev

# any non-master branch tries to build an image as a test.
test:
  stage: test
  script:
    - ./build-images.sh
  except:
    - master

# but only master will run signing checks and pushes
# this is flagged as a build stage so it stops the pipeline quickly.
master:
  stage: build
  script:
    - /usr/local/bin/gitgpgsign_check
  only:
    - master

# duplicated from test, mostly.
deploy:
  stage: deploy
  environment:
    name: deploy
  script:
    - ./build-images.sh
    - /usr/local/bin/publish-docker
  only:
    - master
